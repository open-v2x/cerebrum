context_frames = {
    "abcd701": [
        {
            "secMark": 25500,
            "ptcType": "motor",
            "x": 71.62646028708953,
            "y": 36.569121892406386,
            "speed": 220,
            "heading": 16882,
            "global_track_id": "abcd701",
            "refPos_lat": 319348466,
            "refPos_lon": 1188213963,
            "refPos_ele": None,
            "lat": 319351864,
            "lon": 1188221337,
            "ele": None,
            "ptcId": 701,
            "source": 3,
            "lane": None,
            "width": 162,
            "length": 444,
            "height": 30,
            "timeStamp": 25500,
        }
    ],
    "abcd500": [
        {
            "secMark": 25500,
            "ptcType": "pedestrian",
            "x": 60.87015227526427,
            "y": 42.01854631074059,
            "speed": 53,
            "heading": 14556,
            "global_track_id": "abcd500",
            "refPos_lat": 319348466,
            "refPos_lon": 1188213963,
            "refPos_ele": None,
            "lat": 319352259,
            "lon": 1188220245,
            "ele": None,
            "ptcId": 500,
            "source": 3,
            "lane": None,
            "timeStamp": 25500,
        }
    ],
    "abcd200": [
        {
            "secMark": 24600,
            "ptcType": "motor",
            "x": 45.950870133936405,
            "y": 59.777651336975396,
            "speed": 166,
            "heading": 6400,
            "global_track_id": "abcd200",
            "refPos_lat": 319348466,
            "refPos_lon": 1188213963,
            "refPos_ele": None,
            "lat": 319353810,
            "lon": 1188218649,
            "ele": None,
            "ptcId": 200,
            "source": 3,
            "lane": None,
            "width": 162,
            "length": 444,
            "height": 30,
            "timeStamp": 24600,
        },
        {
            "secMark": 24800,
            "ptcType": "motor",
            "x": 46.50257879644633,
            "y": 59.71841237749904,
            "speed": 221,
            "heading": 6400,
            "global_track_id": "abcd200",
            "refPos_lat": 319348466,
            "refPos_lon": 1188213963,
            "refPos_ele": None,
            "lat": 319353804,
            "lon": 1188218722,
            "ele": None,
            "ptcId": 200,
            "source": 3,
            "lane": None,
            "width": 162,
            "length": 444,
            "height": 30,
            "timeStamp": 24800,
        },
        {
            "secMark": 25000,
            "ptcType": "motor",
            "x": 47.19392644792795,
            "y": 59.558278048895296,
            "speed": 195,
            "heading": 6400,
            "global_track_id": "abcd200",
            "refPos_lat": 319348466,
            "refPos_lon": 1188213963,
            "refPos_ele": None,
            "lat": 319353788,
            "lon": 1188218799,
            "ele": None,
            "ptcId": 200,
            "source": 3,
            "lane": None,
            "width": 162,
            "length": 444,
            "height": 30,
            "timeStamp": 25000,
        },
        {
            "secMark": 25500,
            "ptcType": "motor",
            "x": 48.76801656371355,
            "y": 59.35979312928767,
            "speed": 195,
            "heading": 6400,
            "global_track_id": "abcd200",
            "refPos_lat": 319348466,
            "refPos_lon": 1188213963,
            "refPos_ele": None,
            "lat": 319353771,
            "lon": 1188218989,
            "ele": None,
            "ptcId": 200,
            "source": 3,
            "lane": None,
            "width": 162,
            "length": 444,
            "height": 30,
            "timeStamp": 25500,
        },
        {
            "secMark": 26000,
            "ptcType": "motor",
            "x": 50.57171082831621,
            "y": 59.16193411031813,
            "speed": 210,
            "heading": 6400,
            "global_track_id": "abcd200",
            "refPos_lat": 319348466,
            "refPos_lon": 1188213963,
            "refPos_ele": None,
            "lat": 319353755,
            "lon": 1188219186,
            "ele": None,
            "ptcId": 200,
            "source": 3,
            "lane": None,
            "width": 162,
            "length": 444,
            "height": 30,
            "timeStamp": 26000,
        },
    ],
    "abcd100": [
        {
            "secMark": 24600,
            "ptcType": "pedestrian",
            "x": 59.84604609012604,
            "y": 62.49910408491269,
            "speed": 61,
            "heading": 13422,
            "global_track_id": "abcd100",
            "refPos_lat": 319348466,
            "refPos_lon": 1188213963,
            "refPos_ele": None,
            "lat": 319354069,
            "lon": 1188220115,
            "ele": None,
            "ptcId": 100,
            "source": 3,
            "lane": None,
            "timeStamp": 24600,
        },
        {
            "secMark": 24800,
            "ptcType": "pedestrian",
            "x": 59.84401962757111,
            "y": 62.312795407418164,
            "speed": 60,
            "heading": 13857,
            "global_track_id": "abcd100",
            "refPos_lat": 319348466,
            "refPos_lon": 1188213963,
            "refPos_ele": None,
            "lat": 319354048,
            "lon": 1188220115,
            "ele": None,
            "ptcId": 100,
            "source": 3,
            "lane": None,
            "timeStamp": 24800,
        },
        {
            "secMark": 25000,
            "ptcType": "pedestrian",
            "x": 59.86418812394142,
            "y": 62.080106282476336,
            "speed": 56,
            "heading": 13424,
            "global_track_id": "abcd100",
            "refPos_lat": 319348466,
            "refPos_lon": 1188213963,
            "refPos_ele": None,
            "lat": 319354026,
            "lon": 1188220118,
            "ele": None,
            "ptcId": 100,
            "source": 3,
            "lane": None,
            "timeStamp": 25000,
        },
        {
            "secMark": 25500,
            "ptcType": "pedestrian",
            "x": 59.86291442894936,
            "y": 61.5456171627827,
            "speed": 68,
            "heading": 13037,
            "global_track_id": "abcd100",
            "refPos_lat": 319348466,
            "refPos_lon": 1188213963,
            "refPos_ele": None,
            "lat": 319353971,
            "lon": 1188220118,
            "ele": None,
            "ptcId": 100,
            "source": 3,
            "lane": None,
            "timeStamp": 25500,
        },
        {
            "secMark": 26000,
            "ptcType": "pedestrian",
            "x": 59.87257995324135,
            "y": 60.95947530410662,
            "speed": 60,
            "heading": 13606,
            "global_track_id": "abcd100",
            "refPos_lat": 319348466,
            "refPos_lon": 1188213963,
            "refPos_ele": None,
            "lat": 319353917,
            "lon": 1188220120,
            "ele": None,
            "ptcId": 100,
            "source": 3,
            "lane": None,
            "timeStamp": 26000,
        },
    ],
}

latest_frame = {
    "abcd200": {
        "secMark": 26000,
        "ptcType": "motor",
        "x": 50.57171082831621,
        "y": 59.16193411031813,
        "speed": 210,
        "heading": 6400,
        "global_track_id": "abcd200",
        "refPos_lat": 319348466,
        "refPos_lon": 1188213963,
        "refPos_ele": None,
        "lat": 319353755,
        "lon": 1188219186,
        "ele": None,
        "ptcId": 200,
        "source": 3,
        "lane": None,
        "width": 162,
        "length": 444,
        "height": 30,
        "timeStamp": 26000,
    },
    "abcd100": {
        "secMark": 26000,
        "ptcType": "pedestrian",
        "x": 59.87257995324135,
        "y": 60.95947530410662,
        "speed": 60,
        "heading": 13606,
        "global_track_id": "abcd100",
        "refPos_lat": 319348466,
        "refPos_lon": 1188213963,
        "refPos_ele": None,
        "lat": 319353917,
        "lon": 1188220120,
        "ele": None,
        "ptcId": 100,
        "source": 3,
        "lane": None,
        "timeStamp": 26000,
    },
}
last_ts = 26000
msg = [
    {
        "eventType": 1,
        "collisionType": 1,
        "secMark": 26000,
        "egoInfo": {
            "egoId": "abcd200",
            "egoPos": {"lat": 319353755, "lon": 1188219186},
            "heading": 6400,
            "size": {"length": 444, "width": 162, "height": 30},
            "kinematicsInfo": {
                "speed": 163,
                "accelerate": 48,
                "angularSpeed": 0,
            },
        },
        "otherInfo": {
            "otherId": "abcd100",
            "otherPos": {"lat": 319353917, "lon": 1188220120},
            "heading": 13606,
            "size": {"radius": 50},
            "kinematicsInfo": {
                "speed": 54,
                "accelerate": 14,
                "angularSpeed": 1,
            },
        },
    }
]
show_info = [
    {
        "collision_type": 1,
        "ego": "abcd200",
        "other": "abcd100",
        "ego_current_point": [50.57171082831621, 59.16193411031813],
        "other_current_point": [59.87257995324135, 60.95947530410662],
    }
]

# last_ts = 27100

motors_trajs = {
    "abcd200": {
        "x": [
            45.950870133936405,
            46.50257879644633,
            47.19392644792795,
            48.76801656371355,
            50.57171082831621,
        ],
        "y": [
            59.777651336975396,
            59.71841237749904,
            59.558278048895296,
            59.35979312928767,
            59.16193411031813,
        ],
        "heading": [
            1.3962634015954636,
            1.3962634015954636,
            1.3962634015954636,
            1.3962634015954636,
            1.3962634015954636,
        ],
        "timeStamp": [24.6, 24.8, 25.0, 25.5, 26.0],
        "length": 4.44,
        "width": 1.62,
        "height": 1.5,
        "guid": "abcd200",
        "speed_x": 3.242712582683568,
        "speed_y": -0.47238857938870915,
        "speed": 3.276940015293417,
        "acc_x": 0.9555337301253722,
        "acc_y": -0.1671238688716993,
        "angular_speed": 0.0,
        "traj_point": [
            (52.193067119658, 58.925739820623775),
            (53.81442341099978, 58.68954553092942),
            (55.43577970234156, 58.45335124123506),
            (57.057135993683346, 58.21715695154071),
            (58.67849228502513, 57.980962661846355),
            (60.29984857636692, 57.744768372152),
        ],
        "traj_heading": [
            1.7154557252674287,
            1.715455725267433,
            1.7154557252674287,
            1.7154557252674287,
            1.715455725267428,
            1.715455725267428,
        ],
        "traj_footprint": [
            (
                (50.11302074943406, 57.80417524481095),
                (49.87948901097128, 59.40725444657566),
                (54.273113489881936, 60.0473043964366),
                (54.506645228344716, 58.444225194671894),
            ),
            (
                (51.73437704077584, 57.56798095511659),
                (51.50084530231306, 59.171060156881296),
                (55.89446978122372, 59.811110106742255),
                (56.1280015196865, 58.20803090497755),
            ),
            (
                (53.35573333211762, 57.331786665422236),
                (53.12220159365484, 58.93486586718694),
                (57.5158260725655, 59.57491581704789),
                (57.74935781102828, 57.97183661528318),
            ),
            (
                (54.977089623459406, 57.09559237572788),
                (54.743557884996626, 58.69867157749259),
                (59.137182363907286, 59.338721527353535),
                (59.370714102370066, 57.73564232558883),
            ),
            (
                (56.59844591480118, 56.859398086033536),
                (56.36491417633841, 58.462477287798244),
                (60.758538655249076, 59.102527237659174),
                (60.99207039371185, 57.49944803589447),
            ),
            (
                (58.21980220614297, 56.62320379633918),
                (57.9862704676802, 58.22628299810389),
                (62.379894946590866, 58.86633294796482),
                (62.61342668505364, 57.263253746200114),
            ),
        ],
    }
}
vptc_trajs = {
    "abcd100": {
        "x": [
            59.84604609012604,
            59.84401962757111,
            59.86418812394142,
            59.86291442894936,
            59.87257995324135,
        ],
        "y": [
            62.49910408491269,
            62.312795407418164,
            62.080106282476336,
            61.5456171627827,
            60.95947530410662,
        ],
        "heading": [
            2.9282261525334863,
            3.023128430610678,
            2.9286624848464853,
            2.8442321822812593,
            2.9683687253293565,
        ],
        "timeStamp": [24.6, 24.8, 25.0, 25.5, 26.0],
        "radius": 0.5,
        "guid": "abcd100",
        "ptcType": "pedestrian",
        "speed_x": 0.02687345691919071,
        "speed_y": -1.0840627422302997,
        "speed": 1.0843957818890042,
        "acc_x": 0.027227163696288526,
        "acc_y": -0.29792840516768615,
        "angular_speed": 0.020398535632684345,
        "traj_point": [
            (59.886016681700944, 60.41744393299147),
            (59.89945341016054, 59.87541256187632),
            (59.912890138620135, 59.333381190761166),
            (59.92632686707973, 58.791349819646015),
            (59.939763595539326, 58.24931844853087),
            (59.95320032399892, 57.70728707741572),
        ],
        "traj_heading": [
            3.116808152550914,
            3.116808152550914,
            3.116808152550914,
            3.116808152550913,
            3.116808152550914,
            3.116808152550914,
        ],
    }
}

import json


def http_test():
    import requests

    response = requests.post(
        url="http://127.0.0.1:28304/collision",
        json={
            "context_frames": context_frames,
            "current_frame": latest_frame,
            "last_timestamp": last_ts,
        },
    )
    # print(response.text)
    res = response.json()
    print(res.get("msg") == msg)
    # print(res.get("msg"))
    print(res.get("info") == show_info)
    print(res.get("last_timestamp") == last_ts)
    for key, value in res.get("motors_trajs").items():
        value["traj_point"] = [tuple(v) for v in value["traj_point"]]
        value["traj_footprint"] = [
            tuple(tuple(i) for i in v) for v in value["traj_footprint"]
        ]
    print(res.get("motors_trajs") == motors_trajs)
    for key, value in res.get("vptc_trajs").items():
        value["traj_point"] = [tuple(v) for v in value["traj_point"]]
    print(res.get("vptc_trajs") == vptc_trajs)


def grpc_test():
    import grpc
    from collision_service.grpc_server import (
        collision_grpc_pb2,
        collision_grpc_pb2_grpc,
    )
    import json

    with grpc.insecure_channel("127.0.0.1:28305") as channel:
        stub = collision_grpc_pb2_grpc.CollisionGrpcStub(channel)
        data = collision_grpc_pb2.CollisionRequest(
            data=json.dumps(
                {
                    "context_frames": context_frames,
                    "current_frame": latest_frame,
                    "last_timestamp": last_ts,
                }
            )
        )
        response = stub.collision(data)
        res = json.loads(response.data)
        print(res.get("msg") == msg)
        # print(res.get("msg"))
        print(res.get("info") == show_info)
        print(res.get("last_timestamp") == last_ts)
        for key, value in res.get("motors_trajs").items():
            value["traj_point"] = [tuple(v) for v in value["traj_point"]]
            value["traj_footprint"] = [
                tuple(tuple(i) for i in v) for v in value["traj_footprint"]
            ]
        print(res.get("motors_trajs") == motors_trajs)
        for key, value in res.get("vptc_trajs").items():
            value["traj_point"] = [tuple(v) for v in value["traj_point"]]
        print(res.get("vptc_trajs") == vptc_trajs)


#
async def ws_test():
    from websockets.client import connect
    import json

    async with connect(
        "ws://127.0.0.1:28304/ws",
    ) as websocket:
        await websocket.send(
            json.dumps(
                {
                    "context_frames": context_frames,
                    "current_frame": latest_frame,
                    "last_timestamp": last_ts,
                }
            )
        )
        data = await websocket.recv()
        res = json.loads(data)
        print(res.get("msg") == msg)
        # print(res.get("msg"))
        print(res.get("info") == show_info)
        print(res.get("last_timestamp") == last_ts)
        for key, value in res.get("motors_trajs").items():
            value["traj_point"] = [tuple(v) for v in value["traj_point"]]
            value["traj_footprint"] = [
                tuple(tuple(i) for i in v) for v in value["traj_footprint"]
            ]
        print(res.get("motors_trajs") == motors_trajs)
        for key, value in res.get("vptc_trajs").items():
            value["traj_point"] = [tuple(v) for v in value["traj_point"]]
        print(res.get("vptc_trajs") == vptc_trajs)


if __name__ == "__main__":
    import asyncio

    http_test()
    grpc_test()
    asyncio.run(ws_test())
    # from algo_lib import CollisionWarning
    #
    # warning = CollisionWarning()
    # warning.run(context_frames=context_frames,current_frame=latest_frame,last_timestamp=last_ts)
