context_frames = {
    "ad1405de": [
        {
            "secMark": 45900,
            "ptcType": "motor",
            "x": 30.955018764973314,
            "y": 52.78380503239331,
            "speed": 24,
            "heading": 20931,
            "global_track_id": "ad1405de",
            "refPos_lat": 319348466,
            "refPos_lon": 1188213963,
            "refPos_ele": None,
            "lat": 319353165,
            "lon": 1188217069,
            "ele": None,
            "ptcId": 1405,
            "source": 3,
            "lane": 14,
            "width": 180,
            "length": 500,
            "height": 30,
            "timeStamp": 45900,
        },
        {
            "secMark": 46100,
            "ptcType": "motor",
            "x": 30.860258407640583,
            "y": 52.796282159004804,
            "speed": 24,
            "heading": 20931,
            "global_track_id": "ad1405de",
            "refPos_lat": 319348466,
            "refPos_lon": 1188213963,
            "refPos_ele": None,
            "lat": 319353166,
            "lon": 1188217059,
            "ele": None,
            "ptcId": 1405,
            "source": 3,
            "lane": 14,
            "width": 180,
            "length": 500,
            "height": 30,
            "timeStamp": 46100,
        },
        {
            "secMark": 46200,
            "ptcType": "motor",
            "x": 30.796009315500285,
            "y": 52.808143294943214,
            "speed": 24,
            "heading": 20931,
            "global_track_id": "ad1405de",
            "refPos_lat": 319348466,
            "refPos_lon": 1188213963,
            "refPos_ele": None,
            "lat": 319353167,
            "lon": 1188217053,
            "ele": None,
            "ptcId": 1405,
            "source": 3,
            "lane": 14,
            "width": 180,
            "length": 500,
            "height": 30,
            "timeStamp": 46200,
        },
        {
            "secMark": 46700,
            "ptcType": "motor",
            "x": 30.586743709136968,
            "y": 52.83927114784078,
            "speed": 24,
            "heading": 20931,
            "global_track_id": "ad1405de",
            "refPos_lat": 319348466,
            "refPos_lon": 1188213963,
            "refPos_ele": None,
            "lat": 319353170,
            "lon": 1188217027,
            "ele": None,
            "ptcId": 1405,
            "source": 3,
            "lane": 14,
            "width": 180,
            "length": 500,
            "height": 30,
            "timeStamp": 46700,
        },
        {
            "secMark": 46800,
            "ptcType": "motor",
            "x": 30.507062637148287,
            "y": 52.84590827582649,
            "speed": 24,
            "heading": 20931,
            "global_track_id": "ad1405de",
            "refPos_lat": 319348466,
            "refPos_lon": 1188213963,
            "refPos_ele": None,
            "lat": 319353170,
            "lon": 1188217022,
            "ele": None,
            "ptcId": 1405,
            "source": 3,
            "lane": 14,
            "width": 180,
            "length": 500,
            "height": 30,
            "timeStamp": 46800,
        },
        {
            "secMark": 47300,
            "ptcType": "motor",
            "x": 30.294710634815292,
            "y": 52.875991333466516,
            "speed": 24,
            "heading": 20931,
            "global_track_id": "ad1405de",
            "refPos_lat": 319348466,
            "refPos_lon": 1188213963,
            "refPos_ele": None,
            "lat": 319353173,
            "lon": 1188216996,
            "ele": None,
            "ptcId": 1405,
            "source": 3,
            "lane": 14,
            "width": 180,
            "length": 500,
            "height": 30,
            "timeStamp": 47300,
        },
        {
            "secMark": 47500,
            "ptcType": "motor",
            "x": 30.17668085071794,
            "y": 52.89170290421779,
            "speed": 24,
            "heading": 20931,
            "global_track_id": "ad1405de",
            "refPos_lat": 319348466,
            "refPos_lon": 1188213963,
            "refPos_ele": None,
            "lat": 319353174,
            "lon": 1188216986,
            "ele": None,
            "ptcId": 1405,
            "source": 3,
            "lane": 14,
            "width": 180,
            "length": 500,
            "height": 30,
            "timeStamp": 47500,
        },
    ],
    "ad1409de": [
        {
            "secMark": 45900,
            "ptcType": "motor",
            "x": 11.313444735199946,
            "y": 55.65938600089938,
            "speed": 24,
            "heading": 20931,
            "global_track_id": "ad1409de",
            "refPos_lat": 319348466,
            "refPos_lon": 1188213963,
            "refPos_ele": None,
            "lat": 319353405,
            "lon": 1188214989,
            "ele": None,
            "ptcId": 1409,
            "source": 3,
            "lane": 14,
            "width": 180,
            "length": 500,
            "height": 30,
            "timeStamp": 45900,
        },
        {
            "secMark": 46100,
            "ptcType": "motor",
            "x": 11.218684423285868,
            "y": 55.67186330805081,
            "speed": 24,
            "heading": 20931,
            "global_track_id": "ad1409de",
            "refPos_lat": 319348466,
            "refPos_lon": 1188213963,
            "refPos_ele": None,
            "lat": 319353406,
            "lon": 1188214979,
            "ele": None,
            "ptcId": 1409,
            "source": 3,
            "lane": 14,
            "width": 180,
            "length": 500,
            "height": 30,
            "timeStamp": 46100,
        },
        {
            "secMark": 46200,
            "ptcType": "motor",
            "x": 11.154435364071158,
            "y": 55.68372456801406,
            "speed": 24,
            "heading": 20931,
            "global_track_id": "ad1409de",
            "refPos_lat": 319348466,
            "refPos_lon": 1188213963,
            "refPos_ele": None,
            "lat": 319353407,
            "lon": 1188214973,
            "ele": None,
            "ptcId": 1409,
            "source": 3,
            "lane": 14,
            "width": 180,
            "length": 500,
            "height": 30,
            "timeStamp": 46200,
        },
        {
            "secMark": 46700,
            "ptcType": "motor",
            "x": 10.945169859660393,
            "y": 55.71485282569621,
            "speed": 24,
            "heading": 20931,
            "global_track_id": "ad1409de",
            "refPos_lat": 319348466,
            "refPos_lon": 1188213963,
            "refPos_ele": None,
            "lat": 319353410,
            "lon": 1188214947,
            "ele": None,
            "ptcId": 1409,
            "source": 3,
            "lane": 14,
            "width": 180,
            "length": 500,
            "height": 30,
            "timeStamp": 46700,
        },
        {
            "secMark": 46800,
            "ptcType": "motor",
            "x": 10.865488819983149,
            "y": 55.72149010839958,
            "speed": 24,
            "heading": 20931,
            "global_track_id": "ad1409de",
            "refPos_lat": 319348466,
            "refPos_lon": 1188213963,
            "refPos_ele": None,
            "lat": 319353410,
            "lon": 1188214942,
            "ele": None,
            "ptcId": 1409,
            "source": 3,
            "lane": 14,
            "width": 180,
            "length": 500,
            "height": 30,
            "timeStamp": 46800,
        },
        {
            "secMark": 47300,
            "ptcType": "motor",
            "x": 10.653136919479875,
            "y": 55.751573575845164,
            "speed": 24,
            "heading": 20931,
            "global_track_id": "ad1409de",
            "refPos_lat": 319348466,
            "refPos_lon": 1188213963,
            "refPos_ele": None,
            "lat": 319353413,
            "lon": 1188214916,
            "ele": None,
            "ptcId": 1409,
            "source": 3,
            "lane": 14,
            "width": 180,
            "length": 500,
            "height": 30,
            "timeStamp": 47300,
        },
        {
            "secMark": 47500,
            "ptcType": "motor",
            "x": 10.535107191511255,
            "y": 55.767285376079045,
            "speed": 24,
            "heading": 20931,
            "global_track_id": "ad1409de",
            "refPos_lat": 319348466,
            "refPos_lon": 1188213963,
            "refPos_ele": None,
            "lat": 319353414,
            "lon": 1188214906,
            "ele": None,
            "ptcId": 1409,
            "source": 3,
            "lane": 14,
            "width": 180,
            "length": 500,
            "height": 30,
            "timeStamp": 47500,
        },
    ],
}

latest_frame = {
    "ad1405de": {
        "secMark": 47500,
        "ptcType": "motor",
        "x": 30.17668085071794,
        "y": 52.89170290421779,
        "speed": 24,
        "heading": 20931,
        "global_track_id": "ad1405de",
        "refPos_lat": 319348466,
        "refPos_lon": 1188213963,
        "refPos_ele": None,
        "lat": 319353174,
        "lon": 1188216986,
        "ele": None,
        "ptcId": 1405,
        "source": 3,
        "lane": 14,
        "width": 180,
        "length": 500,
        "height": 30,
        "timeStamp": 47500,
    },
    "ad1409de": {
        "secMark": 47500,
        "ptcType": "motor",
        "x": 10.535107191511255,
        "y": 55.767285376079045,
        "speed": 24,
        "heading": 20931,
        "global_track_id": "ad1409de",
        "refPos_lat": 319348466,
        "refPos_lon": 1188213963,
        "refPos_ele": None,
        "lat": 319353414,
        "lon": 1188214906,
        "ele": None,
        "ptcId": 1409,
        "source": 3,
        "lane": 14,
        "width": 180,
        "length": 500,
        "height": 30,
        "timeStamp": 47500,
    },
}
last_ts = 47500
msg = [
    {
        "secMark": 47500,
        "egoInfo": {
            "egoId": "ad1405de",
            "egoPos": {"lat": 319353174, "lon": 1188216986},
            "speed": 28,
            "heading": 20931,
            "width": 180,
            "length": 500,
            "height": 30,
        },
    },
    {
        "secMark": 47500,
        "egoInfo": {
            "egoId": "ad1409de",
            "egoPos": {"lat": 319353414, "lon": 1188214906},
            "speed": 28,
            "heading": 20931,
            "width": 180,
            "length": 500,
            "height": 30,
        },
    },
]
show_info = [
    {
        "ego": "ad1405de",
        "ego_current_point": [30.17668085071794, 52.89170290421779],
    },
    {
        "ego": "ad1409de",
        "ego_current_point": [10.535107191511255, 55.767285376079045],
    },
]

# last_ts = 27100

motors_trajs = {
    "abcd200": {
        "x": [
            45.950870133936405,
            46.50257879644633,
            47.19392644792795,
            48.76801656371355,
            50.57171082831621,
        ],
        "y": [
            59.777651336975396,
            59.71841237749904,
            59.558278048895296,
            59.35979312928767,
            59.16193411031813,
        ],
        "heading": [
            1.3962634015954636,
            1.3962634015954636,
            1.3962634015954636,
            1.3962634015954636,
            1.3962634015954636,
        ],
        "timeStamp": [24.6, 24.8, 25.0, 25.5, 26.0],
        "length": 4.44,
        "width": 1.62,
        "height": 1.5,
        "guid": "abcd200",
        "speed_x": 3.242712582683568,
        "speed_y": -0.47238857938870915,
        "speed": 3.276940015293417,
        "acc_x": 0.9555337301253722,
        "acc_y": -0.1671238688716993,
        "angular_speed": 0.0,
        "traj_point": [
            (52.193067119658, 58.925739820623775),
            (53.81442341099978, 58.68954553092942),
            (55.43577970234156, 58.45335124123506),
            (57.057135993683346, 58.21715695154071),
            (58.67849228502513, 57.980962661846355),
            (60.29984857636692, 57.744768372152),
        ],
        "traj_heading": [
            1.7154557252674287,
            1.715455725267433,
            1.7154557252674287,
            1.7154557252674287,
            1.715455725267428,
            1.715455725267428,
        ],
        "traj_footprint": [
            (
                (50.11302074943406, 57.80417524481095),
                (49.87948901097128, 59.40725444657566),
                (54.273113489881936, 60.0473043964366),
                (54.506645228344716, 58.444225194671894),
            ),
            (
                (51.73437704077584, 57.56798095511659),
                (51.50084530231306, 59.171060156881296),
                (55.89446978122372, 59.811110106742255),
                (56.1280015196865, 58.20803090497755),
            ),
            (
                (53.35573333211762, 57.331786665422236),
                (53.12220159365484, 58.93486586718694),
                (57.5158260725655, 59.57491581704789),
                (57.74935781102828, 57.97183661528318),
            ),
            (
                (54.977089623459406, 57.09559237572788),
                (54.743557884996626, 58.69867157749259),
                (59.137182363907286, 59.338721527353535),
                (59.370714102370066, 57.73564232558883),
            ),
            (
                (56.59844591480118, 56.859398086033536),
                (56.36491417633841, 58.462477287798244),
                (60.758538655249076, 59.102527237659174),
                (60.99207039371185, 57.49944803589447),
            ),
            (
                (58.21980220614297, 56.62320379633918),
                (57.9862704676802, 58.22628299810389),
                (62.379894946590866, 58.86633294796482),
                (62.61342668505364, 57.263253746200114),
            ),
        ],
    }
}
vptc_trajs = {
    "abcd100": {
        "x": [
            59.84604609012604,
            59.84401962757111,
            59.86418812394142,
            59.86291442894936,
            59.87257995324135,
        ],
        "y": [
            62.49910408491269,
            62.312795407418164,
            62.080106282476336,
            61.5456171627827,
            60.95947530410662,
        ],
        "heading": [
            2.9282261525334863,
            3.023128430610678,
            2.9286624848464853,
            2.8442321822812593,
            2.9683687253293565,
        ],
        "timeStamp": [24.6, 24.8, 25.0, 25.5, 26.0],
        "radius": 0.5,
        "guid": "abcd100",
        "ptcType": "pedestrian",
        "speed_x": 0.02687345691919071,
        "speed_y": -1.0840627422302997,
        "speed": 1.0843957818890042,
        "acc_x": 0.027227163696288526,
        "acc_y": -0.29792840516768615,
        "angular_speed": 0.020398535632684345,
        "traj_point": [
            (59.886016681700944, 60.41744393299147),
            (59.89945341016054, 59.87541256187632),
            (59.912890138620135, 59.333381190761166),
            (59.92632686707973, 58.791349819646015),
            (59.939763595539326, 58.24931844853087),
            (59.95320032399892, 57.70728707741572),
        ],
        "traj_heading": [
            3.116808152550914,
            3.116808152550914,
            3.116808152550914,
            3.116808152550913,
            3.116808152550914,
            3.116808152550914,
        ],
    }
}

speed_limits = {
    "14": {"vehicleMaxSpeed": 833, "vehicleMinSpeed": 833},
    "15": {"vehicleMaxSpeed": 833, "vehicleMinSpeed": 833},
    "20": {"vehicleMaxSpeed": 833, "vehicleMinSpeed": 833},
    "21": {"vehicleMaxSpeed": 833, "vehicleMinSpeed": 833},
    "22": {"vehicleMaxSpeed": 833, "vehicleMinSpeed": 833},
    "16": {"vehicleMaxSpeed": 833, "vehicleMinSpeed": 833},
    "17": {"vehicleMaxSpeed": 833, "vehicleMinSpeed": 833},
    "18": {"vehicleMaxSpeed": 833, "vehicleMinSpeed": 833},
    "19": {"vehicleMaxSpeed": 833, "vehicleMinSpeed": 833},
    "23": {"vehicleMaxSpeed": 833},
    "24": {"vehicleMaxSpeed": 833},
    "1": {"vehicleMaxSpeed": 833},
    "4": {"vehicleMaxSpeed": 833, "vehicleMinSpeed": 833},
    "5": {"vehicleMaxSpeed": 833, "vehicleMinSpeed": 833},
    "6": {"vehicleMaxSpeed": 833, "vehicleMinSpeed": 833},
    "7": {"vehicleMaxSpeed": 833, "vehicleMinSpeed": 833},
    "11": {"vehicleMaxSpeed": 833, "vehicleMinSpeed": 833},
    "12": {"vehicleMaxSpeed": 833, "vehicleMinSpeed": 833},
    "13": {"vehicleMaxSpeed": 833, "vehicleMinSpeed": 833},
    "8": {"vehicleMaxSpeed": 833, "vehicleMinSpeed": 833},
    "9": {"vehicleMaxSpeed": 833, "vehicleMinSpeed": 833},
    "10": {"vehicleMaxSpeed": 833, "vehicleMinSpeed": 833},
    "2": {"vehicleMaxSpeed": 833, "vehicleMinSpeed": 833},
    "3": {"vehicleMaxSpeed": 833, "vehicleMinSpeed": 833},
}
import json


def http_test():
    import requests

    response = requests.post(
        url="http://127.0.0.1:28304/slowspeed",
        json={
            "context_frames": context_frames,
            "current_frame": latest_frame,
            "last_timestamp": last_ts,
            "speed_limits": speed_limits,
        },
    )
    # print(response.text)
    res = response.json()
    print(res.get("msg") == msg)
    # print(res.get("msg"))
    print(res.get("info") == show_info)
    print(res.get("last_timestamp") == last_ts)


def grpc_test():
    import grpc
    from slowspeed_service.grpc_server import (
        slowspeed_grpc_pb2,
        slowspeed_grpc_pb2_grpc,
    )
    import json

    with grpc.insecure_channel("127.0.0.1:28305") as channel:
        stub = slowspeed_grpc_pb2_grpc.SlowSpeedGrpcStub(channel)
        data = slowspeed_grpc_pb2.SlowSpeedRequest(
            data=json.dumps(
                {
                    "context_frames": context_frames,
                    "current_frame": latest_frame,
                    "last_timestamp": last_ts,
                    "speed_limits": speed_limits,
                }
            )
        )
        response = stub.slow_speed(data)
        res = json.loads(response.data)
        print(res.get("msg") == msg)
        # print(res.get("msg"))
        print(res.get("info") == show_info)
        print(res.get("last_timestamp") == last_ts)


#
async def ws_test():
    from websockets.client import connect
    import json

    async with connect(
        "ws://127.0.0.1:28304/ws",
    ) as websocket:
        await websocket.send(
            json.dumps(
                {
                    "context_frames": context_frames,
                    "current_frame": latest_frame,
                    "last_timestamp": last_ts,
                    "speed_limits": speed_limits,
                }
            )
        )
        data = await websocket.recv()
        res = json.loads(data)
        print(res.get("msg") == msg)
        # print(res.get("msg"))
        print(res.get("info") == show_info)
        print(res.get("last_timestamp") == last_ts)


if __name__ == "__main__":
    import asyncio

    http_test()
    grpc_test()
    asyncio.run(ws_test())
    # from algo_lib import SlowspeedWarning
    #
    # warning = SlowspeedWarning()
    # msg_, show_info_, last_timestamp = warning.run(context_frames=context_frames, current_frame=latest_frame,
    #                                                last_timestamp=last_ts,
    #                                                speed_limits=speed_limits)
    #
    # print(msg_ == msg)
    # print(show_info_ == show_info)
    # print(last_timestamp == last_ts)
